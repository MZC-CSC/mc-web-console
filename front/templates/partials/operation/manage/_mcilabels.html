<!-- MCI Labels Tab Content -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">MCI Labels</h3>
        <div class="card-actions btn-actions d-flex align-items-center">
          <div class="form-check form-switch me-3" style="display: flex; align-items: center; transform: translateY(2px);">
            <input class="form-check-input" type="checkbox" id="showSystemLabels" onchange="toggleSystemLabels()" style="margin-top: 0;">
            <label class="form-check-label" for="showSystemLabels" style="margin-left: 0.5rem;">
              Show System Labels
            </label>
          </div>
          <a
            href="#edit_labels"
            class="btn btn-outline-warning"
            onclick="openMciLabelEditor(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="icon"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                stroke="none"
                d="M0 0h24v24H0z"
                fill="none"
              ></path>
              <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"></path>
              <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"></path>
              <path d="M16 5l3 3"></path>
            </svg>
            Edit Labels
          </a>
        </div>
      </div>
      <div class="card-body">
        <div id="mci-labels-content">
          <div class="text-center text-muted">
            <p>No labels found. Click "Edit Labels" to add labels to this MCI.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// MCI Label Editor 열기 함수
function openMciLabelEditor() {
  // 현재 선택된 MCI 정보 가져오기
  const mciId = window.currentMciId;
  const mciName = document.getElementById('mci_info_name')?.textContent || 'Unknown MCI';
  
  console.log('openMciLabelEditor - mciId:', mciId, 'mciName:', mciName);
  
  if (!mciId || mciId === "" || mciId === "undefined") {
    alert('Please select an MCI first.');
    return;
  }
  
  // Label Editor 모달 열기
  webconsolejs['pages/operation/manage/mci'].openLabelEditorModal('mci', mciId, mciName);
}

// MCI Labels 표시 함수 (전역으로 등록)
window.displayMciLabels = function(labels) {
  console.log("displayMciLabels called with:", labels);
  
  const container = document.getElementById('mci-labels-content');
  console.log("Container element:", container);
  
  if (!labels || Object.keys(labels).length === 0) {
    console.log("No labels to display");
    container.innerHTML = `
      <div class="text-center text-muted">
        <p>No labels found. Click "Edit Labels" to add labels to this MCI.</p>
      </div>
    `;
    return;
  }
  
  // 라벨을 system 라벨과 사용자 라벨로 분류
  const allLabels = Object.entries(labels);
  const systemLabels = allLabels.filter(([key]) => key.startsWith('sys.'));
  const userLabels = allLabels.filter(([key]) => !key.startsWith('sys.'));
  
  console.log("System labels:", systemLabels);
  console.log("User labels:", userLabels);
  
  // 현재 토글 상태 확인
  const showSystemLabels = document.getElementById('showSystemLabels')?.checked || false;
  
  // 표시할 라벨 결정
  const labelsToShow = showSystemLabels ? allLabels : userLabels;
  
  if (labelsToShow.length === 0) {
    container.innerHTML = `
      <div class="text-center text-muted">
        <p>No ${showSystemLabels ? '' : 'user '}labels found. Click "Edit Labels" to add labels to this MCI.</p>
      </div>
    `;
    return;
  }
  
  // 테이블 행 생성 (system 라벨과 사용자 라벨 구분)
  const tableRows = labelsToShow.map(([key, value]) => {
    const isSystemLabel = key.startsWith('sys.');
    const rowClass = isSystemLabel ? 'table-secondary' : '';
    const keyClass = isSystemLabel ? 'text-muted fst-italic' : 'text-muted';
    
    return `
      <tr class="${rowClass}">
        <td class="${keyClass}">${key}</td>
        <td>${value}</td>
      </tr>
    `;
  }).join('');
  
  console.log("Table rows HTML:", tableRows);
  
  container.innerHTML = `
    <div class="table-responsive">
      <table class="table table-vcenter">
        <thead>
          <tr>
            <th class="text-muted">Key</th>
            <th class="text-muted">Value</th>
          </tr>
        </thead>
        <tbody>
          ${tableRows}
        </tbody>
      </table>
    </div>
  `;
  
  console.log("Labels table rendered");
}

// Labels 탭이 활성화될 때 Label 정보 로드
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOMContentLoaded - setting up Labels tab listener");
  
  // Labels 탭 클릭 이벤트 리스너
  const labelsTab = document.querySelector('a[href="#tabs-mci-labels"]');
  console.log("Labels tab element:", labelsTab);
  
  if (labelsTab) {
    labelsTab.addEventListener('click', function() {
      console.log("Labels tab clicked");
      loadMciLabels();
    });
  } else {
    console.log("Labels tab element not found");
  }
});

// System 라벨 토글 함수
function toggleSystemLabels() {
  console.log("toggleSystemLabels called");
  
  // 현재 저장된 라벨 데이터가 있는지 확인
  if (window.currentMciLabels) {
    console.log("Re-rendering labels with new filter");
    displayMciLabels(window.currentMciLabels);
  } else {
    console.log("No cached labels, reloading...");
    loadMciLabels();
  }
}

// MCI Labels 로드 함수
async function loadMciLabels() {
  console.log("loadMciLabels called");
  console.log("window.currentMciId:", window.currentMciId);
  console.log("window.currentNsId:", window.currentNsId);
  
  if (!window.currentMciId) {
    console.log("No currentMciId found");
    return;
  }
  
  try {
    // Getmci API로 MCI 상세 정보 조회
    console.log("Calling getMci API...");
    const mciResponse = await webconsolejs["common/api/services/mci_api"].getMci(window.currentNsId, window.currentMciId);
    console.log("getMci API response:", mciResponse);
    
    if (mciResponse && mciResponse.responseData && mciResponse.responseData.label) {
      const labels = mciResponse.responseData.label;
      console.log("Labels found:", labels);
      
      // 라벨 데이터를 전역 변수에 저장 (토글 시 재사용)
      window.currentMciLabels = labels;
      
      displayMciLabels(labels);
    } else {
      console.log("No labels found in response");
      window.currentMciLabels = {};
      displayMciLabels({});
    }
  } catch (error) {
    console.error("Error loading MCI labels:", error);
    window.currentMciLabels = {};
    displayMciLabels({});
  }
}
</script>
